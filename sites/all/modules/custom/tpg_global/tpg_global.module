<?php

/**
 * @file
 * Code for the TPG Global.
 */

define('MARGIN_SPACING', serialize(array(0, 24, 48)));
define('MARGIN_BEFORE_CLASS', 'tpg_global_paragraphs_margin_before');
define('MARGIN_AFTER_CLASS', 'tpg_global_paragraphs_margin_after');

/**
 * Implements hook_node_view_alter().
 */
function tpg_global_node_view_alter(&$build) {

  // Hiding node title for overview view mode.
  if ($build['#view_mode'] == 'overview') {
    $node = $build['#node'];
    unset($node->title);
  }
}

/**
 * Implements hook_node_view().
 */
function tpg_global_node_view($node, $view_mode, $langcode) {

  // Altering Full view mode.
  if ($view_mode == 'full' && in_array($node->type, array('events_detail', 'paragraphs_page', 'artist', 'prints'))) {
    $paragraphs_data = array();
    switch ($node->type) {
      case 'events_detail':
        $paragraphs_data = &$node->content['field_paragraphs_entity'];
        break;
      case 'paragraphs_page':
      case 'artist':
      case 'prints':
        $paragraphs_data = &$node->content['field_paragraphs_content'];
        break;
    }
    foreach ($paragraphs_data as $key => $value) {
      if (is_int($key)) {
        // Fetching the key of the paragraphs item.
        $item_key = key($value['entity']['paragraphs_item']);

        // Altering Reading width Lightbox paragraphs bundle.
        if ($value['entity']['paragraphs_item'][$item_key]['#bundle'] == 'image_reading_width_colorbox') {
          // Fetching Reading width image title value.
          $image_title = $paragraphs_data[$key]['entity']['paragraphs_item'][$item_key]['field_reading_image']['#items'][0]['title'];
          $paragraphs_data[$key]['entity']['paragraphs_item'][$item_key]['reading_width_image_lightbox_tit'][0]['#markup'] = '<div class="colorbox-content-image-title">' . $image_title . '</div>';
        }
      }
    }
  }

  // Event Dates format markup updated.
  if (($view_mode == 'full' || $view_mode == 'overview') && $node->type == 'events_detail') {
    $paragraphs_entity = array();
    $paragraphs_entity = &$node->content['field_paragraphs_entity'];

    foreach ($paragraphs_entity as $key => $value) {
      if (is_int($key)) {
        // Fetching the key of the paragraphs item.
        $item_key = key($value['entity']['paragraphs_item']);

        if ($value['entity']['paragraphs_item'][$item_key]['#bundle'] == 'title_section') {
          // Fetching Title section pragraph bundle event start date and end date.
          $start_date = $paragraphs_entity[$key]['entity']['paragraphs_item'][$item_key]['#entity']->field_event_dates['und'][0]['value'];
          $end_date = $paragraphs_entity[$key]['entity']['paragraphs_item'][$item_key]['#entity']->field_event_dates['und'][0]['value2'];
          $start_date_year = date('Y', strtotime($start_date));
          $end_date_year = date('Y', strtotime($end_date));
          $date_string = '';

          $start_date_without_time = date('d m Y', strtotime($start_date));
          $end_date_without_time = date('d m Y', strtotime($end_date));

          $start_time = date('G:i', strtotime($start_date));
          $end_time = date('G:i', strtotime($end_date));

          // Changing format of Event Date display.
          if ($start_date == $end_date) {
            $date_string = format_date(strtotime($start_date), 'event_format');
          }
          elseif ($start_date_without_time == $end_date_without_time && $start_time != $end_time) {
            $date_string = format_date(strtotime($start_date), 'event_format') . ' - ' . format_date(strtotime($start_date), 'custom', 'G:i') . ' - ' . format_date(strtotime($end_date), 'custom', 'G:i');
          }
          elseif ($start_date_year == $end_date_year) {
            // Checking empty start and end time.
            if (empty((int)$start_time) && empty((int)$end_time)) {
              $date_string = format_date(strtotime($start_date), 'day_month_short') . ' - ' . format_date(strtotime($end_date), 'day_month_year');
            } else {
              $date_string = format_date(strtotime($start_date), 'day_month_short') . ' - ' . format_date(strtotime($end_date), 'day_month_year') . ' ' . format_date(strtotime($start_date), 'custom', 'G:i') . ' - ' . format_date(strtotime($end_date), 'custom', 'G:i');
            }
          }
          else {
            // Checking empty start and end time.
            if (empty((int)$start_time) && empty((int)$end_time)) {
              $date_string = format_date(strtotime($start_date), 'day_month_year') . ' - ' . format_date(strtotime($end_date), 'day_month_year');
            } else {
              $date_string = format_date(strtotime($start_date), 'day_month_year') . ' - ' . format_date(strtotime($end_date), 'day_month_year') . ' - ' . format_date(strtotime($start_date), 'custom', 'G:i') . ' - ' . format_date(strtotime($end_date), 'custom', 'G:i');
            }
          }
          $paragraphs_entity[$key]['entity']['paragraphs_item'][$item_key]['event_start_end_dates'][0]['#markup'] = '<div class="date-display-range">' . $date_string . '</div>';
        }
      }
    }
  }

  // Altering the Overview view mode content.
  if ($view_mode == 'overview') {
    $paragraphs_content = array();
    switch ($node->type) {
      case 'events_detail':
        $paragraphs_content = &$node->content['field_paragraphs_entity'];
        break;
      case 'paragraphs_page':
        $paragraphs_content = &$node->content['field_paragraphs_content'];
        break;
    }
    foreach ($paragraphs_content as $key => $value) {
      if (is_int($key)) {
        // Fetching the key of the paragraphs item.
        $item_key = key($value['entity']['paragraphs_item']);

        // Altering title and overview image field for title_section paragraph bundle.
        if ($value['entity']['paragraphs_item'][$item_key]['#bundle'] == 'title_section') {

          // Adding link to node page for title field.
          $title_markup = &$paragraphs_content[$key]['entity']['paragraphs_item'][$item_key]['field_paragraph_title'][0]['#markup'];
          $title_markup = l($title_markup, drupal_get_path_alias('node/' . $node->nid));

          // Adding image path.
          $paragraphs_content[$key]['entity']['paragraphs_item'][$item_key]['field_paragraphs_overview_image'][0]['#path']['path'] = drupal_get_path_alias('node/' . $node->nid);

          // Remove Event Start End Date display suite code field for Paragraphs page node.
          if ($node->type == 'paragraphs_page') {
            unset($paragraphs_content[$key]['entity']['paragraphs_item'][$item_key]['event_start_end_dates']);
          }
        }
      }
    }
  }

  // Altering the image path for External Link Card Image field.
  if ($node->type == 'external_links' && $view_mode == 'overview') {
    if ($node->content['field_card_image']) {
      $node->content['field_card_image'][0]['#path']['path'] = $node->content['field_external_link_title'][0]['#element']['url'];
    }
  }
}

/**
 * Implements hook_views_query_alter().
 */
function tpg_global_views_query_alter(&$view, &$query) {

  // Whats on query alter.
  if ($view->name == 'whats_on' && in_array($view->current_display, array('now_upcoming_view_page'))) {
    // Adding daterange picker values to expose filters.
    // Combine filter is altered to show daterangepicker plugin using form alter.
    if (!$view->exposed_input['combine']) {
      unset($query->where[2]);
    }
    elseif ($view->exposed_input['combine']) {
      $range_values = explode('-', $view->exposed_input['combine']);
      $start_date = format_date(strtotime($range_values[0]), 'custom', 'Y-m-d');
      $end_date = format_date(strtotime($range_values[1]), 'custom', 'Y-m-d');
      // Adding starting date.
      $query->where[2]['conditions'][0]['value'][':field_data_field_event_dates_field_event_dates_value'] = $start_date;
      $query->where[2]['conditions'][1]['value'][':field_data_field_event_dates_field_event_dates_value2'] = $end_date;
      // Unset date condition for Anytime select value.
      if (!preg_match('/[A-Za-z].*[0-9]|[0-9].*[A-Za-z]/', $view->exposed_input['combine'])) {
        unset($query->where[2]);
      }
    }
  }

  // Past Programme query alter.
  if ($view->name == 'whats_on' && in_array($view->current_display, array('past_programme_view_page'))) {
    // @TODO : change accordingly for year.
    // Exposed filter : When - event year quert altered for Before 2012 option.
    if (isset($view->exposed_input['field_event_dates_value_1']) && $view->exposed_input['field_event_dates_value_1']['value']['year'] == t('Before 2012')) {

      // Altering Date format to check for year less than 2012.
      $query->where[1]['conditions'][2]['field'] = "DATE_FORMAT(paragraphs_item_field_data_field_paragraphs_entity__field_data_field_event_dates.field_event_dates_value, '%Y') < :field_data_field_event_dates_field_event_dates_value
";
      $query->where[1]['conditions'][2]['value'][':field_data_field_event_dates_field_event_dates_value'] = '2012';
    }
  }
  // Artist view.
  if ($view->name == 'artist' && in_array($view->current_display, array('collection_0', 'collection_1', 'collection_2', 'collection_3', 'collection_4'))) {

    // Altering contextual filter value for Prints page changing target id to related artist node id.
    $node = menu_get_object('node');
    if ($node->type == 'prints' && !empty($node->field_print_artist['und'][0]['target_id'])) {
      // Artist node nid related to Print Artist field.
      $artist_nid = $node->field_print_artist['und'][0]['target_id'];
      // Contextual filter alter.
      $view->args[0] = $artist_nid;
      // Fetching field id for each of the collection view block.
      $field_id = key($query->where[0]['conditions'][0]['value']);
      $query->where[0]['conditions'][0]['value']["$field_id"] = $artist_nid;

      // Removing current prints node from collections list.
      $query->where[1]['conditions'][] = array(
        'field' => 'node.nid',
        'value' => $node->nid,
        'operator' => '!='
      );

      // Altering view tilte for collections.
      if ($view->current_display == 'collection_0') {
        $view->build_info['title'] = t('More works from this artist');
      }
    }

    // Loading collection term ids for each artist node.
    if (!empty($view->args[0])) {
      $collection_term_ids = _tpg_global_fetch_collection_term_id_artist_node($view->args[0]);
    }
    $display_state = TRUE;
    // Altering Collection term id for each collection attached to artist entity reference for prints type.
    foreach($collection_term_ids as $key => $value) {
      if ($view->current_display == "collection_$key") {
        $query->where[1]['conditions'][1]['value'] = $value;
        $display_state = FALSE;
      }
    }
  }
}

/**
 * Loads collection term ids for particular artist node nid argument from print content type using views.
 *
 * @param string $artist_nid  The artist node nid.
 *
 * @return array $collection_term_ids Collection term ids for related artist node.
 */
function _tpg_global_fetch_collection_term_id_artist_node($artist_nid) {
  $collection_term_ids = array();
  $collection_terms = views_get_view_result('artist', 'collections_artist', $artist_nid);
    foreach ($collection_terms as $key => $value) {
    // Removing duplicate object terms.
    if (!in_array($value->taxonomy_term_data_field_data_field_print_collections_tid, $collection_term_ids)) {
      $collection_term_ids[] = $value->taxonomy_term_data_field_data_field_print_collections_tid;
    }
  }
  return $collection_term_ids;
}

/**
 * Implements hook_views_pre_render().
 */
function tpg_global_views_pre_render(&$view) {

  // Related Activities view alter.
  if ($view->name == 'related_activities' && ($view->current_display == 'related_activities_block' || $view->current_display == 'event_related_activities')) {
    $related_nodes = array();
    $node = menu_get_object('node');

    $paragraphs_content = $node->field_paragraphs_content['und'];
    if ($view->current_display == 'event_related_activities') {
      $paragraphs_content = $node->field_events_related_activities['und'];
    }

    foreach ($paragraphs_content as $key => $paragraph_item) {
      // Loading paragraphs bundle from automated id.
      $data = paragraphs_item_load($paragraph_item['value']);
      // Fetching Related Activities node nids.
      if ($data->bundle == 'related_activities') {
        foreach ($data->field_related_activities['und'] as $key => $related_activities) {

          // Getting only the targeted id values all others unsetting from view result.
          foreach ($view->result as $view_key => $view_value) {
            if ($view_value->nid == $related_activities['target_id']) {
              $related_nodes[] = $view_value;
            }
          }
        }
      }
    }
    $view->result = $related_nodes;
  }

  // Event Start and End markup update.
  if (in_array($view->name, array('whats_on', 'related_activities', 'homepage')) && (in_array($view->current_display, array('next_season_block', 'now_upcoming_view_page', 'past_programme_view_page', 'featured_past_programme_block', 'event_related_activities', 'current_exhibitions_highlights_block')))) {
    foreach ($view->result as $key => $value) {
      $start_date = $value->field_field_event_dates[0]['raw']['value'];
      $end_date = $value->field_field_event_dates[0]['raw']['value2'];
      $start_date_year = date('Y', strtotime($start_date));
      $end_date_year = date('Y', strtotime($end_date));
      $markup = '';
      if ($start_date == $end_date) {
        $markup = format_date(strtotime($end_date), 'event_format');
      }
      elseif ($start_date_year == $end_date_year) {
        $markup = format_date(strtotime($start_date), "day_month_short") . ' - ' . format_date(strtotime($end_date), "day_month_year");
      }
      else {
        $markup = format_date(strtotime($start_date), "day_month_year") . ' - ' . format_date(strtotime($end_date), "day_month_year");
      }
      if ($markup) {
        $view->result[$key]->field_field_event_dates[0]['rendered']['#markup'] = '<div class="date-display-range">' . $markup . '</div>';
      }
    }
  }

  // Header Image Lightbox view.
  if ($view->name == 'paragraphs_entities' && $view->current_display == 'header_image_lightbox') {

    // Adding background class using background class field.
    if ($bg_color_value = $view->result[0]->field_field_background_color[0]['raw']['value']) {
      drupal_add_js(array('tpg_global' => array('header_image_lightbox_bg_color' => 'colorbox-background-' . drupal_strtolower($bg_color_value))), 'setting');
    }
    $caption_value = '';
    // Converting html to plain text for Image caption.
    if ($caption_value = &$view->result[0]->paragraphs_item_field_data_field_paragraphs_header_section_f) {
      $caption_value = drupal_html_to_text($caption_value);
      drupal_add_js(array('tpg_global' => array('header_image_lightbox_caption' => $caption_value)), 'setting');
    }

    if ($image_title_value = $view->result[0]->field_field_header_image_lightbox[0]['raw']['title']) {
      drupal_add_js(array('tpg_global' => array('header_image_lightbox_title' => $image_title_value)), 'setting');
    }
    else {
      $caption_value = '';
    }
  }
}

/**
 * Implements hook_form_alter().
 */
function tpg_global_form_alter(&$form, &$form_state, $form_id) {

  if ($form_id == 'paragraphs_page_node_form' || $form_id == 'artist_node_form' || $form_id == 'prints_node_form') {
    // Adding homepage weight options.
    _tpg_global_homepage_weight_range($form);

    // Hiding Event type and Event date fields.
    foreach ($form['field_paragraphs_content']['und'] as $key => $value) {
      if (is_int($key)) {

        // Setting options for Field Collection Margin before and after fields.
        _tpg_global_margin_before_after_options($form, 'field_paragraphs_content', $form_state, $key);

        if ($value['#bundle'] == 'title_section') {
          unset($form['field_paragraphs_content']['und'][$key]['field_paragraphs_event_type']);
          unset($form['field_paragraphs_content']['und'][$key]['field_event_dates']);
          // Unset fields.
          if (in_array($form_id, array('artist_node_form', 'prints_node_form'))) {
            unset($form['field_paragraphs_content']['und'][$key]['field_paragraphs_tags_viewpoints']);
            unset($form['field_paragraphs_content']['und'][$key]['field_paragraphs_show_tags']);
            unset($form['field_paragraphs_content']['und'][$key]['field_paragraphs_date_published']);
          }
        }
        // Removing Share Block Field.
        if ($value['#bundle'] == 'social_media_links') {
          unset($form['field_paragraphs_content']['und'][$key]['field_show_share_block']);
        }
      }
    }
  }

  if ($form_id == 'events_detail_node_form') {

    // @TODO - For enabling Artists Field remove below line.
    $form['field_event_artists']['#access'] = FALSE;

    // Hiding Page Type field.
    foreach ($form['field_paragraphs_entity']['und'] as $key => $value) {
      if (is_int($key)) {

        // Setting options for Field Collection Margin before and after fields.
        _tpg_global_margin_before_after_options($form, 'field_paragraphs_entity', $form_state, $key);

        if ($value['#bundle'] == 'title_section') {
          unset($form['field_paragraphs_entity']['und'][$key]['field_paragraphs_type']);
        }
        // Removing Share Block Field.
        if ($value['#bundle'] == 'social_media_links') {
          unset($form['field_paragraphs_entity']['und'][$key]['field_show_share_block']);
        }
      }
    }
    // Adding homepage weight options.
    _tpg_global_homepage_weight_range($form);
  }

  // Overview node form alter.
  if ($form_id == 'overview_page_node_form') {
    // Altering the Field collection overview section.
    foreach ($form['field_overview_section']['und'] as $key => $value) {
      if (is_int($key)) {
        $form['field_overview_section']['und'][$key]['field_links']['und']['form']['field_external_link_title']['und'][0]['#title_display'] = 'invisible';
        $form['field_overview_section']['und'][$key]['field_links']['und']['form']['status']['#access'] = FALSE;

        // Altering the Inline entity form action buttons.
        $form['field_overview_section']['und'][$key]['field_links']['und']['actions']['ief_add']['#value'] = t('use new');
        $form['field_overview_section']['und'][$key]['field_links']['und']['actions']['ief_add_existing']['#value'] = t('use existing');
      }
    }
  }

  if ($form_id == 'views_exposed_form' && $form_state['view']->name == 'whats_on') {

    // Adding Date Range picker for News and Upcoming view filter.
    if ($form_state['view']->current_display == 'now_upcoming_view_page') {
      $form['combine'] = array(
        '#type' => 'textfield',
        '#size' => false,
        '#default_value' => t('Anytime'),
        '#prefix' => '<div class="daterangepicker-wrapper">',
        '#suffix' => '</div>',
        '#attributes' => array(
          'id' => array('daterangepicker'),
          'class' => array('daterangepicker-input'),
        ),
      );
    }

    if ($form_state['view']->current_display == 'now_upcoming_view_page' || $form_state['view']->current_display == 'past_programme_view_page') {

      $form['submit']['#weight'] = 5;
      // Altering the filter select options.
      $form['field_paragraphs_event_type_tid']['#options']['All'] = t('EVERYTHING');
      $form['tid']['#prefix'] = '<div class="who-select-prefix">' . t('ALL ARTISTS') . '</div>';
      $form['tid']['#attributes']['placeholder'] = t('SEARCH BY NAME');
      // @TODO : Remove below to enable Artists Filter.
      unset($form['tid']);
      if ($form['field_event_for_tid']) {
        $form['field_event_for_tid']['#options']['All'] = t('EVERYONE');
      }
    }

    // Altering Past Programme view exposed form display.
    if ($form_state['view']->current_display == 'past_programme_view_page') {
      // Adding current year as default When Year filter.
      if (!isset($form_state['input']['field_event_dates_value_1'])) {
        $form_state['input']['field_event_dates_value_1']['value']['year'] = date('Y');
      }
      // Adding preprocess for when filter to add Before 2012 option to year filter.
      $form['#after_build'][] = '_tpg_global_views_exposed_form_date_select_alter';
    }
  }

  // Explore all content view.
  if ($form_id == 'views_exposed_form' && $form_state['view']->name == 'expore_all_content') {
    // Changing All option filter value.
    $form['field_paragraphs_type_tid']['#options']['All'] = t('EVERYTHING');
    $form['field_form_tid']['#options']['All'] = t('EVERYTHING');
  }

  // Setting Unpublished as default publishing option for new nodes..
  $content_types =  array('article_node_form', 'page_node_form', 'document_node_form', 'events_detail_node_form', 'external_links_node_form', 'header_image_node_form', 'internal_links_node_form', 'overview_page_node_form', 'paragraphs_page_node_form', 'product_display_node_form', 'viewpoint_node_form');

  if (in_array($form_id, $content_types) && empty($form['nid']['#value'])) {
    $form['options']['status']['#default_value'] = 0;
  }
}

/**
 * Alters after build form element for When Year filter for
 * Past Programme exposed view.
 *
 * @param $form array
 *    Exposed Form array.
 * @param $form_state array
 *    Form State value.
 * @return $form
 */
function _tpg_global_views_exposed_form_date_select_alter(&$form, &$form_state) {
  if (isset($form['field_event_dates_value_1'])) {
    // Reversing the Year filter to show Year in decreasing order.
    $form['field_event_dates_value_1']['value']['year']['#options'] = array_reverse($form['field_event_dates_value_1']['value']['year']['#options'], true);
    // Adding Before 2012 element to Year filter.
    $form['field_event_dates_value_1']['value']['year']['#options']['Before 2012'] = t('Before 2012');
    // Removing default option.
    unset($form['field_event_dates_value_1']['value']['year']['#options']['']);
  }
  return $form;
}

/**
 * Adding range of weights for Homepage weight field.
 *
 * @param $form array
 *    Content type form array.
 */
function _tpg_global_homepage_weight_range(&$form = array()) {

  $range = array();
  for ($i = -20; $i <= 20; ++$i) {
    $range[$i] = $i;
  }
  $form['field_homepage_weight']['und']['#options'] = $range;
  $form['field_homepage_weight']['und']['#default_value'] = $form['#node']->field_homepage_weight['und'][0] ? $form['#node']->field_homepage_weight['und'][0] : 0;

  // Whats on weight for event details content type.
  if ($form['field_whats_on_weight']) {
    $form['field_whats_on_weight']['und']['#options'] = $range;
    $form['field_whats_on_weight']['und']['#default_value'] = $form['#node']->field_whats_on_weight['und'][0] ? $form['#node']->field_whats_on_weight['und'][0] : 0;
  }
}

/**
 * Adding Options for Margin before and after fields.
 *
 * @param $form array
 *    Content type form array.
 */
function _tpg_global_margin_before_after_options(&$form = array(), $field_name, $form_state, $key) {

  if (isset($form[$field_name]['und'][$key]['field_margins']['und'][0]['field_margin_before']) || isset($form[$field_name]['und'][$key]['field_margins']['und'][0]['field_margin_after'])) {

    // Adding options to margin before and margin after fields.
    $form[$field_name]['und'][$key]['field_margins']['und'][0]['field_margin_before']['und']['#options'] = $form[$field_name]['und'][$key]['field_margins']['und'][0]['field_margin_after']['und']['#options'] = unserialize(MARGIN_SPACING);

    // Load field collection for margins field.
    $field_margins_id = $form_state['field'][$field_name]['und']['entity'][$key]->field_margins['und'][0]['value'];
    $field_collection_load = _tpg_global_field_collection_entity($field_margins_id);

    // Collect Margin before and after fields value.
    $margin_before_value = $field_collection_load->field_margin_before['und'][0]['value'];
    $margin_after_value = $field_collection_load->field_margin_after['und'][0]['value'];;

    // Adding Default value for margin before and margin after fields.
    $form[$field_name]['und'][$key]['field_margins']['und'][0]['field_margin_before']['und']['#default_value'] = isset($margin_before_value) ? $margin_before_value : 0;
    $form[$field_name]['und'][$key]['field_margins']['und'][0]['field_margin_after']['und']['#default_value'] = isset($margin_after_value) ? $margin_after_value : 1;
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 *    User Login Form alter.
 */
function tpg_global_form_user_login_alter(&$form, &$form_state, $form_id) {
  $form['actions']['submit']['#suffix'] = l('<div class="user-forgot-password-link"> â€º ' . t('forgot password?') . '</div>', 'user/password', array('html' => TRUE));
  $form['name']['#title'] = t('Name or email');
  unset($form['name']['#description']);
  unset($form['pass']['#description']);
  $form['actions']['submit']['#value'] = t('Login');
  $form['actions']['#weight'] = 2;
}

/**
 * Implements hook_block_info().
 */
function tpg_global_block_info() {
  $blocks = array();
  $blocks['create_account'] = array(
    'info' => t('Create an account'),
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function tpg_global_block_view($delta='') {
  $block = array();

  switch($delta) {
    case 'create_account' :
      $block['content'] = drupal_render(drupal_get_form('create_account_form'));
      break;
  }
  return $block;
}

/**
 * Drupal form showing User Resigter Form.
 * @return
 *   returns form element.
 */
function create_account_form($form, $form_state) {

  // Fetching block id from block machine name.
  $block_id = '';
  if (module_exists('fe_block')) {
    $query = db_select('fe_block_boxes', 'fe_b')
            ->fields('fe_b', array('bid'))
            ->condition('fe_b.machine_name', 'user_login_create_account_intro');
    $block_id = $query->execute()->fetchField();
  }
  // Adding Create an account intro text.
  if ($block_id) {
    $create_account_intro_block_view = module_invoke('block', 'block_view', $block_id);
    $form['user_register_intro_block'] = array(
      '#type' => 'item',
      '#title' => t('Create an account'),
      '#markup' => render($create_account_intro_block_view['content']), //render($yoti_block_view['content']),
      '#weight' => 3,
    );
  }
  // Adding User Register form.
  $form['user_register'] = array(
    '#type' => 'item',
    '#markup' => drupal_render(drupal_get_form('user_register_form')),
    '#weight' => 4,
  );
  return $form;
}

/**
 * Implements hook_form_FORM_ID_alter().
 *    User Register Form alter.
 */
function tpg_global_form_user_register_form_alter(&$form, &$form_state, $form_id) {
  $form['account']['name']['#title'] = t('Name');
  unset($form['account']['name']['#description']);
  unset($form['account']['mail']['#description']);
  unset($form['account']['pass']['#description']);
  $form['actions']['submit']['#value'] = t('Create an account');
}

/**
 * Implements hook_menu_alter().
 */
function tpg_global_menu_alter(&$items) {
  $items['user']['title callback'] = '_tpg_global_user_menu_title';
}

/**
 * Menu item title callback for the 'user' path.
 *
 * Anonymous users shouldn't see anything, but authenticated users are
 * expected to see "My account".
 */
function _tpg_global_user_menu_title() {
  return user_is_logged_in() ? t('My account') : t('');
}

/**
 * Alter the layout render array.
 *
 * @param $layout_render_array
 *   The render array
 * @param $context
 *   An array with the context that is being rendered. Available keys are
 *   - entity
 *   - entity_type
 *   - bundle
 *   - view_mode
 * @param array $vars
 *   All variables available for render. You can use this to add css classes.
 */
function tpg_global_ds_pre_render_alter(&$layout_render_array, $context, &$vars) {

  $margin_constant = unserialize(MARGIN_SPACING);
  // Adding Marging before class.
  if (isset($vars['elements']['#entity']->field_margins['und'][0]['value'])) {

    $margin_fields_load = _tpg_global_field_collection_entity($vars['elements']['#entity']->field_margins['und'][0]['value']);
    $vars['classes_array'][] = MARGIN_BEFORE_CLASS . '_' . $margin_constant[$margin_fields_load->field_margin_before['und'][0]['value']];
    $vars['classes_array'][] = MARGIN_AFTER_CLASS . '_' . $margin_constant[$margin_fields_load->field_margin_after['und'][0]['value']];
  }
}

/**
 * Loads Field Collection entity.
 *
 * @param string
 *  Field collection entity id.
 *
 * @return array
 *  Field Collection Entity object.
 */
function _tpg_global_field_collection_entity($item_id = '') {
  $field_collection_load = '';
  $field_collection_load = entity_load('field_collection_item', array($item_id));
  return $field_collection_load[$item_id];
}
